#include "ActionControl.h"
#include "../../Database/WorkLogDBHelper.h"
#include "../../Database/WorkLogData.h"
#include "../../Lib/StringUtils.hpp"
#include "../../Lib/StreamUtils.hpp"
#include "../../Lib/SystemUtils.hpp"
#include "../../Database/DBFailureException.h"
#include <vector>
#include <iostream>
#include <random>
#include <sstream>
#include <fstream>
#include <cstdio>
#include <cstdlib>

/* --==--==--==--==--==--==--==--==--==-- */

/* --==--==--==--==--==--==--==--==--==-- */
bool ActionControl::confirm(){
	while(true){
		std::cout << "Apply Operation, OK? (y/n)" << std::endl;
		char confirm;
		std::cin >> confirm;
		if(confirm == 'y' || confirm == 'Y')
			return true;
		else if(confirm == 'n' || confirm == 'N')
			return false;
		std::cout << "Please [y] or [n]" << std::endl;
	}
	std::cout << std::endl;
}

/* --==--==--==--==--==--==--==--==--==-- */

void ActionControl::doViewWorkLogList(){
	std::vector<WorkLogData> workLog = m_dbHelper.getWorkLog();
	for(int i=0; i<workLog.size(); i++){
		std::cout << "|"
		          << workLog[i].getId()       << "\t|"
		          << workLog[i].getTime()     << "\t|"
		          << workLog[i].getFunction() << "\t|"
		          << workLog[i].getTarget()   << "\t|"
		          << std::endl;
	}
}

void ActionControl::doViewWorkLogDetail(int id){
	std::vector<WorkLogData> workLog = m_dbHelper.getWorkLog();
	int i;
	try{
		WorkLogData data = m_dbHelper.getWorkLogSearchById(id);
		std::cout << " --------------------"                        << std::endl
		          << " Time: "                << data.getTime()     << std::endl
		          << " Function: "            << data.getFunction() << std::endl
		          << " Target: "              << data.getTarget()   << std::endl
		          << " Comment: "                                    << std::endl;
				  for(std::string line : alib::split(data.getComment(), '\n'))
					  std::cout << " % " << line << std::endl;
		std::cout << " --------------------"                        << std::endl;
	}catch(DBFailureException e){
		std::cerr << ">> No such WorkLog ID: " << id << std::endl;
	}
}

#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wwrite-strings"
void ActionControl::doEditWorkLog(bool reeditFlag, int id){
	/* 乱数でテンポラリファイル名を作成 */
	std::string fileList[3];
	const int FILE_NUM = 3;
	/*
	 * Function
	 * Target
	 * Comment
	 */
	std::random_device rand;
	for(int i=0; i<FILE_NUM; i++){
		std::stringstream ss;
		ss << "/tmp/" << rand();
		fileList[i] = ss.str();
	}

	/* 再編集モードならあらかじめテキストの内容をセットしておく */
	if(reeditFlag){
		try{
			WorkLogData workLog = m_dbHelper.getWorkLogSearchById(id);
			std::ofstream fout(fileList[0], std::ios::out);
			fout << workLog.getFunction();
			fout.close();  fout.open(fileList[1], std::ios::out);
			fout << workLog.getTarget();
			fout.close();  fout.open(fileList[2], std::ios::out);
			fout << workLog.getComment();
		}catch(DBFailureException e){
			std::cerr << ">> No such WorkLog ID: " << id << std::endl;
			return;
		}
	}

	/* 処理、対象、コメントを読み込み */
	std::cout << "Do not change by Enter key" << std::endl;
	std::vector<std::string> texts = this->editDetails(fileList[0], fileList[1], fileList[2]);
	//std::stringstream texts[3];

	/* ファイル削除 */
	for(std::string file : fileList)
		std::remove(file.c_str());

	/* データベースに書き込み */
	std::cout << " --------------------"         << std::endl
	          << " Function: " << texts[0] << std::endl
	          << " Target: "   << texts[1] << std::endl
	          << " Comment: "                    << std::endl;
			  std::string line;
			  //while( texts[2] >> line )
			  for(std::string line : alib::split(texts[2], '\n'))
				  std::cout << " % " << line << std::endl;
	std::cout << " --------------------"         << std::endl;
	if(this->confirm()){
		try{
			if(!reeditFlag){
				WorkLogData logData( time(nullptr), texts[0], texts[1], texts[2] );
				m_dbHelper.writeWorkLog(logData);
			}else{
				WorkLogData logData( id, time(nullptr), texts[0], texts[1], texts[2] );
				m_dbHelper.updateWorkLog(logData);
			}
		}catch(DBFailureException e){
			std::cerr << e.what()                                             << std::endl
			          << ">> Writing to Database faild"                       << std::endl
			          << ">> Directory Permission is Readable and Writable ?" << std::endl;
			return;
		}
		std::cout << std::endl
		          << " --------------------" << std::endl
		          << " >> WorkLog Witten ! " << std::endl
		          << " --------------------" << std::endl;
	}else{
		std::cout << " >> Witten Cancelled! " << std::endl;
	}
}
#pragma GCC diagnostic pop
#pragma GCC diagnostic push

void ActionControl::doRemoveWorkLog(int id){
	try{
		WorkLogData workLog = m_dbHelper.getWorkLogSearchById(id);
		std::cout << " --------------------"                          << std::endl
		          << "Time: "                << workLog.getTime()     << std::endl
		          << "Function: "            << workLog.getFunction() << std::endl
		          << "Target: "              << workLog.getTarget()   << std::endl
		          << " --------------------"                          << std::endl;
	}catch(DBFailureException e){
		std::cerr << ">> No such WorkLog ID: " << id << std::endl;
		return;
	}

	std::cout << ">> Remove This WorkLog." << std::endl;
	if(this->confirm())
		m_dbHelper.removeWorkLog(id);
}

/* --==--==--==--==--==--==--==--==--==-- */
std::vector<std::string> ActionControl::editDetails(
		const std::string& funcPath,
		const std::string& tarPath,
		const std::string& comPath)
	throw(alib::SystemCommandCallException, alib::SystemInterruptedException)
{
	std::vector<std::string> details;
	const int FILE_NUM = 3;
	std::string fileList[] = { funcPath, tarPath, comPath };

	/* シェル変数読み込み */
	std::string editor = std::getenv("EDITOR");

	for(int i=0; i<FILE_NUM; i++){
		std::stringstream detail;

		// Commentのみ処理を特殊化(TODO:allUseEditorオプションにより)
		int err = system( (editor+" "+fileList[i]).c_str() );
		if(err == -1){
			throw alib::SystemCommandCallException(
					">> Opening $EDITOR faild"
					">> Do you have an editor ?");
		}else{
			std::ifstream fin(fileList[i], std::ios::in);
			std::string line;

			try{
				// Commentのみ処理を特殊化
				if(i != 2){
					fin >> line;
					detail << line;
					if(line == "")  throw DBFailureException("Text is Empty");
				}else{
					alib::unsetStreamDelimiterSpace(fin);
					alib::unsetStreamDelimiterSpace(detail);
					while( fin >> line )
						detail << line << std::endl;
					if(line == "")
						std::cout << "Warn>> Comment is Empty" << std::endl;
				}
			}catch(DBFailureException e){
				std::cout << ">> " << e.what() << std::endl;
				std::cout << ">> If Continue(c), Retry(r), Abort(a)." << std::endl;

				bool getFlag = false;
				char a;
				while(!getFlag){
					std::cin >> a;
					switch(a){
						case 'r':
							i--;
						case 'c':
							getFlag = true;
							break;
						case 'a':
							throw alib::SystemInterruptedException(">> Operation Aborted");
						default:
							std::cout << ">> Please [c] or [r] or [a]." << std::endl;
							break;
					}
					continue;
				}

			}
		}

		details.push_back( detail.str() );
	}
	return details;
}

/* --==--==--==--==--==--==--==--==--==-- */
